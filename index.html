<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Diff Viewer</title>
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d2d;
            --text-primary: #d4d4d4;
            --text-secondary: #808080;
            --text-muted: #858585;
            --border-color: #3c3c3c;
            --accent-color: #569cd6;
            --btn-primary-bg: #0e639c;
            --btn-primary-hover: #1177bb;
            --original-color: #f48771;
            --modified-color: #89d185;
            --changed-color: #e3b341;
            --line-added-bg: rgba(35, 134, 54, 0.2);
            --line-added-num-bg: rgba(35, 134, 54, 0.3);
            --line-removed-bg: rgba(218, 54, 51, 0.2);
            --line-removed-num-bg: rgba(218, 54, 51, 0.3);
            --line-changed-bg: rgba(227, 179, 65, 0.15);
            --line-changed-num-bg: rgba(227, 179, 65, 0.25);
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #888888;
            --border-color: #d0d0d0;
            --accent-color: #0066cc;
            --btn-primary-bg: #0066cc;
            --btn-primary-hover: #0052a3;
            --original-color: #d32f2f;
            --modified-color: #388e3c;
            --changed-color: #f57c00;
            --line-added-bg: rgba(76, 175, 80, 0.15);
            --line-added-num-bg: rgba(76, 175, 80, 0.25);
            --line-removed-bg: rgba(244, 67, 54, 0.15);
            --line-removed-num-bg: rgba(244, 67, 54, 0.25);
            --line-changed-bg: rgba(255, 152, 0, 0.15);
            --line-changed-num-bg: rgba(255, 152, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.8rem;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .toolbar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: var(--border-color);
            border-color: var(--accent-color);
        }

        .btn-primary {
            background-color: var(--btn-primary-bg);
            border-color: var(--btn-primary-bg);
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: var(--btn-primary-hover);
        }

        .btn-theme {
            font-size: 1.1rem;
            padding: 8px 12px;
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .text-panel {
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-secondary);
            border-radius: 4px 4px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .panel-header h3 {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .panel-header .original { color: var(--original-color); }
        .panel-header .modified { color: var(--modified-color); }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filename {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: normal;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .panel-actions {
            display: flex;
            gap: 6px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .file-input {
            display: none;
        }

        .text-input {
            width: 100%;
            height: 250px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0 0 4px 4px;
            resize: vertical;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .text-input.drag-over {
            border-color: var(--accent-color);
            background-color: var(--bg-secondary);
            border-style: dashed;
        }

        .swap-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-swap {
            padding: 12px;
            font-size: 1.2rem;
        }

        .diff-section {
            margin-top: 20px;
        }

        .diff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border-radius: 4px 4px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .diff-header h2 {
            font-size: 1rem;
            font-weight: 500;
        }

        .diff-header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-copy {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-copy.copied {
            background-color: var(--modified-color);
            border-color: var(--modified-color);
            color: #ffffff;
        }

        .copy-icon {
            font-size: 0.9rem;
        }

        .diff-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border: 1px solid var(--border-color);
            border-radius: 0 0 4px 4px;
            overflow: hidden;
        }

        .diff-panel {
            overflow-x: auto;
        }

        .diff-panel:first-child {
            border-right: 1px solid var(--border-color);
        }

        .diff-panel-header {
            padding: 8px 12px;
            background-color: var(--bg-tertiary);
            font-size: 0.85rem;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .diff-panel:first-child .diff-panel-header {
            color: var(--original-color);
        }

        .diff-panel:last-child .diff-panel-header {
            color: var(--modified-color);
        }

        .diff-content {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }

        .diff-line {
            display: flex;
            min-height: 21px;
        }

        .line-number {
            min-width: 45px;
            padding: 0 8px;
            text-align: right;
            color: var(--text-muted);
            background-color: var(--bg-primary);
            user-select: none;
            border-right: 1px solid var(--border-color);
        }

        .line-content {
            flex: 1;
            padding: 0 12px;
            white-space: pre;
            overflow-x: auto;
        }

        .line-added {
            background-color: var(--line-added-bg);
        }

        .line-added .line-number {
            background-color: var(--line-added-num-bg);
            color: var(--modified-color);
        }

        .line-added .line-content {
            color: var(--modified-color);
        }

        .line-removed {
            background-color: var(--line-removed-bg);
        }

        .line-removed .line-number {
            background-color: var(--line-removed-num-bg);
            color: var(--original-color);
        }

        .line-removed .line-content {
            color: var(--original-color);
        }

        .line-changed {
            background-color: var(--line-changed-bg);
        }

        .line-changed .line-number {
            background-color: var(--line-changed-num-bg);
            color: var(--changed-color);
        }

        .line-unchanged {
            background-color: transparent;
        }

        .line-empty {
            background-color: var(--bg-secondary);
        }

        .line-empty .line-number {
            background-color: var(--bg-secondary);
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            font-size: 0.85rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .stat-dot.added { background-color: var(--modified-color); }
        .stat-dot.removed { background-color: var(--original-color); }
        .stat-dot.changed { background-color: var(--changed-color); }
        .stat-dot.unchanged { background-color: var(--text-secondary); }

        @media (max-width: 900px) {
            .input-section {
                grid-template-columns: 1fr;
            }

            .swap-container {
                order: -1;
            }

            .btn-swap {
                transform: rotate(90deg);
            }

            .diff-container {
                grid-template-columns: 1fr;
            }

            .diff-panel:first-child {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Text Diff Viewer</h1>
            <p>Compare two text snippets side-by-side with highlighted differences</p>
        </header>

        <div class="toolbar">
            <button class="btn btn-primary" id="compareBtn">Compare</button>
            <button class="btn" id="clearAllBtn">Clear All</button>
            <button class="btn" id="sampleBtn">Load Sample</button>
            <button class="btn btn-theme" id="themeToggleBtn" title="Toggle light/dark theme">ðŸŒ™</button>
        </div>

        <section class="input-section">
            <div class="text-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <h3 class="original">Original</h3>
                        <span class="filename" id="originalFilename"></span>
                    </div>
                    <div class="panel-actions">
                        <input type="file" class="file-input" id="originalFileInput" accept=".txt,.json,.md,.js,.ts,.css,.html,.xml,.yaml,.yml,.py,.java,.c,.cpp,.h,.go,.rs,.rb,.php,.sh,.sql,.csv">
                        <button class="btn btn-small" id="uploadOriginalBtn" title="Upload file">Upload</button>
                        <button class="btn btn-small" id="clearOriginalBtn">Clear</button>
                    </div>
                </div>
                <textarea class="text-input" id="originalText" placeholder="Paste text, drag & drop a file, or click Upload..."></textarea>
            </div>

            <div class="swap-container">
                <button class="btn btn-swap" id="swapBtn" title="Swap texts">â‡„</button>
            </div>

            <div class="text-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <h3 class="modified">Modified</h3>
                        <span class="filename" id="modifiedFilename"></span>
                    </div>
                    <div class="panel-actions">
                        <input type="file" class="file-input" id="modifiedFileInput" accept=".txt,.json,.md,.js,.ts,.css,.html,.xml,.yaml,.yml,.py,.java,.c,.cpp,.h,.go,.rs,.rb,.php,.sh,.sql,.csv">
                        <button class="btn btn-small" id="uploadModifiedBtn" title="Upload file">Upload</button>
                        <button class="btn btn-small" id="clearModifiedBtn">Clear</button>
                    </div>
                </div>
                <textarea class="text-input" id="modifiedText" placeholder="Paste text, drag & drop a file, or click Upload..."></textarea>
            </div>
        </section>

        <section class="diff-section" id="diffSection" style="display: none;">
            <div class="diff-header">
                <h2>Diff Result</h2>
                <div class="diff-header-actions">
                    <button class="btn btn-small btn-copy" id="copyDiffBtn" title="Copy diff to clipboard">
                        <span class="copy-icon">ðŸ“‹</span>
                        <span id="copyBtnText">Copy Diff</span>
                    </button>
                </div>
            </div>
            <div class="diff-container">
                <div class="diff-panel">
                    <div class="diff-panel-header">Original</div>
                    <div class="diff-content" id="diffOriginal"></div>
                </div>
                <div class="diff-panel">
                    <div class="diff-panel-header">Modified</div>
                    <div class="diff-content" id="diffModified"></div>
                </div>
            </div>
            <div class="stats-bar" id="statsBar"></div>
        </section>
    </div>

    <script>
        // Theme management
        const themeToggleBtn = document.getElementById('themeToggleBtn');

        function getStoredTheme() {
            return localStorage.getItem('diffViewerTheme') || 'dark';
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('diffViewerTheme', theme);
            themeToggleBtn.textContent = theme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
            themeToggleBtn.title = theme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme';
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        // Initialize theme on load
        setTheme(getStoredTheme());
        themeToggleBtn.addEventListener('click', toggleTheme);

        // DOM Elements
        const originalText = document.getElementById('originalText');
        const modifiedText = document.getElementById('modifiedText');
        const compareBtn = document.getElementById('compareBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const clearOriginalBtn = document.getElementById('clearOriginalBtn');
        const clearModifiedBtn = document.getElementById('clearModifiedBtn');
        const swapBtn = document.getElementById('swapBtn');
        const sampleBtn = document.getElementById('sampleBtn');
        const diffSection = document.getElementById('diffSection');
        const diffOriginal = document.getElementById('diffOriginal');
        const diffModified = document.getElementById('diffModified');
        const statsBar = document.getElementById('statsBar');
        const originalFileInput = document.getElementById('originalFileInput');
        const modifiedFileInput = document.getElementById('modifiedFileInput');
        const uploadOriginalBtn = document.getElementById('uploadOriginalBtn');
        const uploadModifiedBtn = document.getElementById('uploadModifiedBtn');
        const originalFilename = document.getElementById('originalFilename');
        const modifiedFilename = document.getElementById('modifiedFilename');
        const copyDiffBtn = document.getElementById('copyDiffBtn');
        const copyBtnText = document.getElementById('copyBtnText');

        // Store current diff data for copying
        let currentDiffData = null;

        // Diff Algorithm - Longest Common Subsequence based
        function computeLCS(original, modified) {
            const m = original.length;
            const n = modified.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (original[i - 1] === modified[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }

            return dp;
        }

        function backtrackLCS(dp, original, modified, i, j) {
            const result = [];

            while (i > 0 && j > 0) {
                if (original[i - 1] === modified[j - 1]) {
                    result.unshift({ type: 'unchanged', originalIdx: i - 1, modifiedIdx: j - 1 });
                    i--;
                    j--;
                } else if (dp[i - 1][j] >= dp[i][j - 1]) {
                    result.unshift({ type: 'removed', originalIdx: i - 1 });
                    i--;
                } else {
                    result.unshift({ type: 'added', modifiedIdx: j - 1 });
                    j--;
                }
            }

            while (i > 0) {
                result.unshift({ type: 'removed', originalIdx: i - 1 });
                i--;
            }

            while (j > 0) {
                result.unshift({ type: 'added', modifiedIdx: j - 1 });
                j--;
            }

            return result;
        }

        function computeDiff(originalLines, modifiedLines) {
            const dp = computeLCS(originalLines, modifiedLines);
            const operations = backtrackLCS(dp, originalLines, modifiedLines, originalLines.length, modifiedLines.length);

            // Post-process to detect "changed" lines (adjacent remove + add)
            const processed = [];
            let i = 0;

            while (i < operations.length) {
                const current = operations[i];

                if (current.type === 'removed' && i + 1 < operations.length && operations[i + 1].type === 'added') {
                    // This is a changed line
                    processed.push({
                        type: 'changed',
                        originalIdx: current.originalIdx,
                        modifiedIdx: operations[i + 1].modifiedIdx
                    });
                    i += 2;
                } else {
                    processed.push(current);
                    i++;
                }
            }

            return processed;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderDiff(originalLines, modifiedLines, diffOps) {
            // Store diff data for copying
            currentDiffData = { originalLines, modifiedLines, diffOps };

            let originalHtml = '';
            let modifiedHtml = '';
            let originalLineNum = 0;
            let modifiedLineNum = 0;

            const stats = { added: 0, removed: 0, changed: 0, unchanged: 0 };

            for (const op of diffOps) {
                switch (op.type) {
                    case 'unchanged':
                        originalLineNum++;
                        modifiedLineNum++;
                        stats.unchanged++;
                        originalHtml += `<div class="diff-line line-unchanged">
                            <span class="line-number">${originalLineNum}</span>
                            <span class="line-content">${escapeHtml(originalLines[op.originalIdx])}</span>
                        </div>`;
                        modifiedHtml += `<div class="diff-line line-unchanged">
                            <span class="line-number">${modifiedLineNum}</span>
                            <span class="line-content">${escapeHtml(modifiedLines[op.modifiedIdx])}</span>
                        </div>`;
                        break;

                    case 'removed':
                        originalLineNum++;
                        stats.removed++;
                        originalHtml += `<div class="diff-line line-removed">
                            <span class="line-number">${originalLineNum}</span>
                            <span class="line-content">${escapeHtml(originalLines[op.originalIdx])}</span>
                        </div>`;
                        modifiedHtml += `<div class="diff-line line-empty">
                            <span class="line-number"></span>
                            <span class="line-content"></span>
                        </div>`;
                        break;

                    case 'added':
                        modifiedLineNum++;
                        stats.added++;
                        originalHtml += `<div class="diff-line line-empty">
                            <span class="line-number"></span>
                            <span class="line-content"></span>
                        </div>`;
                        modifiedHtml += `<div class="diff-line line-added">
                            <span class="line-number">${modifiedLineNum}</span>
                            <span class="line-content">${escapeHtml(modifiedLines[op.modifiedIdx])}</span>
                        </div>`;
                        break;

                    case 'changed':
                        originalLineNum++;
                        modifiedLineNum++;
                        stats.changed++;
                        originalHtml += `<div class="diff-line line-changed">
                            <span class="line-number">${originalLineNum}</span>
                            <span class="line-content">${escapeHtml(originalLines[op.originalIdx])}</span>
                        </div>`;
                        modifiedHtml += `<div class="diff-line line-changed">
                            <span class="line-number">${modifiedLineNum}</span>
                            <span class="line-content">${escapeHtml(modifiedLines[op.modifiedIdx])}</span>
                        </div>`;
                        break;
                }
            }

            diffOriginal.innerHTML = originalHtml || '<div class="empty-state">No content</div>';
            diffModified.innerHTML = modifiedHtml || '<div class="empty-state">No content</div>';

            // Render stats
            const total = stats.added + stats.removed + stats.changed + stats.unchanged;
            statsBar.innerHTML = `
                <div class="stat-item">
                    <span class="stat-dot added"></span>
                    <span>${stats.added} added</span>
                </div>
                <div class="stat-item">
                    <span class="stat-dot removed"></span>
                    <span>${stats.removed} removed</span>
                </div>
                <div class="stat-item">
                    <span class="stat-dot changed"></span>
                    <span>${stats.changed} changed</span>
                </div>
                <div class="stat-item">
                    <span class="stat-dot unchanged"></span>
                    <span>${stats.unchanged} unchanged</span>
                </div>
                <div class="stat-item">
                    <span>Total: ${total} lines</span>
                </div>
            `;

            // Sync scroll between panels
            syncScroll();
        }

        function syncScroll() {
            const leftPanel = diffOriginal;
            const rightPanel = diffModified;

            leftPanel.onscroll = () => {
                rightPanel.scrollTop = leftPanel.scrollTop;
            };

            rightPanel.onscroll = () => {
                leftPanel.scrollTop = rightPanel.scrollTop;
            };
        }

        function compare() {
            const original = originalText.value;
            const modified = modifiedText.value;

            if (!original && !modified) {
                diffSection.style.display = 'none';
                return;
            }

            const originalLines = original.split('\n');
            const modifiedLines = modified.split('\n');

            const diffOps = computeDiff(originalLines, modifiedLines);
            renderDiff(originalLines, modifiedLines, diffOps);

            diffSection.style.display = 'block';
        }

        // File handling
        function handleFile(file, textArea, filenameSpan) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                textArea.value = e.target.result;
                filenameSpan.textContent = file.name;
                filenameSpan.title = file.name;
                debounceCompare();
            };
            reader.onerror = () => {
                alert('Error reading file: ' + file.name);
            };
            reader.readAsText(file);
        }

        function setupDragAndDrop(textArea, filenameSpan) {
            textArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                textArea.classList.add('drag-over');
            });

            textArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                textArea.classList.remove('drag-over');
            });

            textArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                textArea.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0], textArea, filenameSpan);
                }
            });
        }

        setupDragAndDrop(originalText, originalFilename);
        setupDragAndDrop(modifiedText, modifiedFilename);

        // File input handlers
        uploadOriginalBtn.addEventListener('click', () => originalFileInput.click());
        uploadModifiedBtn.addEventListener('click', () => modifiedFileInput.click());

        originalFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0], originalText, originalFilename);
            }
        });

        modifiedFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0], modifiedText, modifiedFilename);
            }
        });

        // Event Listeners
        compareBtn.addEventListener('click', compare);

        clearAllBtn.addEventListener('click', () => {
            originalText.value = '';
            modifiedText.value = '';
            originalFilename.textContent = '';
            modifiedFilename.textContent = '';
            diffSection.style.display = 'none';
            clearStorage();
        });

        clearOriginalBtn.addEventListener('click', () => {
            originalText.value = '';
            originalFilename.textContent = '';
        });

        clearModifiedBtn.addEventListener('click', () => {
            modifiedText.value = '';
            modifiedFilename.textContent = '';
        });

        swapBtn.addEventListener('click', () => {
            const tempText = originalText.value;
            originalText.value = modifiedText.value;
            modifiedText.value = tempText;

            const tempFilename = originalFilename.textContent;
            originalFilename.textContent = modifiedFilename.textContent;
            modifiedFilename.textContent = tempFilename;
        });

        sampleBtn.addEventListener('click', () => {
            originalText.value = `function greet(name) {
    console.log("Hello, " + name);
    return true;
}

const user = "World";
greet(user);`;

            modifiedText.value = `function greet(name, formal) {
    if (formal) {
        console.log("Good day, " + name);
    } else {
        console.log("Hello, " + name);
    }
    return true;
}

const user = "World";
const isFormal = false;
greet(user, isFormal);`;

            compare();
        });

        // Auto-compare on input (with debounce)
        let debounceTimer;
        function debounceCompare() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                saveToStorage();
                if (originalText.value || modifiedText.value) {
                    compare();
                }
            }, 500);
        }

        originalText.addEventListener('input', debounceCompare);
        modifiedText.addEventListener('input', debounceCompare);

// Copy diff to clipboard
        function generateUnifiedDiff() {
            if (!currentDiffData) return '';

            const { originalLines, modifiedLines, diffOps } = currentDiffData;
            const lines = [];

            lines.push('--- Original');
            lines.push('+++ Modified');
            lines.push('');

            for (const op of diffOps) {
                switch (op.type) {
                    case 'unchanged':
                        lines.push('  ' + originalLines[op.originalIdx]);
                        break;
                    case 'removed':
                        lines.push('- ' + originalLines[op.originalIdx]);
                        break;
                    case 'added':
                        lines.push('+ ' + modifiedLines[op.modifiedIdx]);
                        break;
                    case 'changed':
                        lines.push('- ' + originalLines[op.originalIdx]);
                        lines.push('+ ' + modifiedLines[op.modifiedIdx]);
                        break;
                }
            }

            return lines.join('\n');
        }

        async function copyDiffToClipboard() {
            const diffText = generateUnifiedDiff();
            if (!diffText) {
                return;
            }

            try {
                await navigator.clipboard.writeText(diffText);

                // Show success feedback
                copyDiffBtn.classList.add('copied');
                copyBtnText.textContent = 'Copied!';

                setTimeout(() => {
                    copyDiffBtn.classList.remove('copied');
                    copyBtnText.textContent = 'Copy Diff';
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = diffText;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                copyDiffBtn.classList.add('copied');
                copyBtnText.textContent = 'Copied!';

                setTimeout(() => {
                    copyDiffBtn.classList.remove('copied');
                    copyBtnText.textContent = 'Copy Diff';
                }, 2000);
            }
        }

        copyDiffBtn.addEventListener('click', copyDiffToClipboard);

        // localStorage persistence
        const STORAGE_KEYS = {
            original: 'diffViewer_original',
            modified: 'diffViewer_modified'
        };

        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.original, originalText.value);
                localStorage.setItem(STORAGE_KEYS.modified, modifiedText.value);
            } catch (e) {
                // localStorage not available (private browsing, quota exceeded)
            }
        }

        function loadFromStorage() {
            try {
                const savedOriginal = localStorage.getItem(STORAGE_KEYS.original);
                const savedModified = localStorage.getItem(STORAGE_KEYS.modified);
                if (savedOriginal) originalText.value = savedOriginal;
                if (savedModified) modifiedText.value = savedModified;
                if (savedOriginal || savedModified) {
                    debounceCompare();
                }
            } catch (e) {
                // localStorage not available
            }
        }

        function clearStorage() {
            try {
                localStorage.removeItem(STORAGE_KEYS.original);
                localStorage.removeItem(STORAGE_KEYS.modified);
            } catch (e) {
                // localStorage not available
            }
        }

        // Load saved content on startup
        loadFromStorage()
    </script>
</body>
</html>
